<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãã‚ã°ã‚“ èª­ã¿ä¸Šã’ç®— ç·´ç¿’ãƒ„ãƒ¼ãƒ«ï¼ˆv3-fix3ï¼‰</title>
<style>
  :root { color-scheme: light dark; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; line-height: 1.6; margin: 1.2rem; }
  h1 { font-size: 1.25rem; margin-bottom: .6rem; }
  fieldset { border: 1px solid #ccc; border-radius: .6rem; padding: .8rem 1rem; margin-bottom: 1rem; }
  label { display: inline-block; margin-right: .6rem; }
  select, input[type="number"], input[type="range"], button { font-size: 1rem; padding: .35rem .6rem; }
  .row { display: flex; flex-wrap: wrap; gap: .8rem; align-items: center; margin: .4rem 0; }
  .grow { flex: 1 1 220px; }
  .buttons { display: flex; gap: .6rem; flex-wrap: wrap; }
  .log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Consolas, "Roboto Mono", monospace;
         border: 1px solid #ddd; border-radius: .5rem; padding: .6rem; min-height: 6rem; background: rgba(0,0,0,.03); }
  .muted { opacity: .75; font-size: .92rem; }
  .ok { color: #0b6; }
  .warn { color: #b60; }
  .err { color: #c33; }
  .util { margin: .6rem 0 1rem; display: flex; gap: .6rem; flex-wrap: wrap; align-items: center; }
</style>
</head>
<body>
  <h1>ãã‚ã°ã‚“ èª­ã¿ä¸Šã’ç®— ç·´ç¿’ãƒ„ãƒ¼ãƒ«ï¼ˆv3-fix3ï¼‰</h1>

  <div class="util">
    <button id="initVoicesBtn">ğŸ”§ éŸ³å£°ã‚’åˆæœŸåŒ–</button>
    <button id="testUtterBtn">ğŸ¤ ãƒ†ã‚¹ãƒˆç™ºè©±</button>
    <span class="muted">â€» æœ€åˆã«ã€ŒéŸ³å£°ã‚’åˆæœŸåŒ–ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚</span>
  </div>

  <fieldset>
    <legend>è¨­å®š</legend>

    <div class="row">
      <label>æ¡æ•°ï¼š</label>
      <input id="digits" type="number" min="2" max="12" value="3" />
      <span class="muted">ï¼ˆ2ã€œ12æ¡ï¼‰</span>
    </div>

    <div class="row">
      <label>å£æ•°ï¼š</label>
      <input id="terms" type="number" min="5" max="20" value="10" />
      <span class="muted">ï¼ˆ5ã€œ20å£ï¼‰</span>
    </div>

    <div class="row">
      <label>ãƒ¢ãƒ¼ãƒ‰ï¼š</label>
      <label><input type="radio" name="mode" value="add" checked /> è¶³ã—ç®—ã®ã¿</label>
      <label><input type="radio" name="mode" value="mix" /> å¼•ãç®—ã‚’æ··ãœã‚‹ï¼ˆæœ€å¤§30%ï¼‰</label>
      <span class="muted">â€» é€”ä¸­çµæœãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã‚ˆã†åˆ¶å¾¡</span>
    </div>

    <div class="row">
      <label class="grow">èª­ã¿ä¸Šã’é€Ÿåº¦ï¼š
        <input id="rate" type="range" min="0.6" max="1.6" step="0.05" value="1.0" style="width: 240px; vertical-align: middle;" />
      </label>
      <span id="rateVal">1.00Ã—</span>
      <label class="grow">å„å£ã®é–“éš”ï¼ˆç§’ï¼‰ï¼š
        <input id="gap" type="range" min="0.2" max="2.0" step="0.1" value="0.7" style="width: 240px; vertical-align: middle;" />
      </label>
      <span id="gapVal">0.7s</span>
    </div>

    <div class="row">
      <label class="grow">ç­”ãˆå‰ã®å¾…ã¡ï¼ˆç§’ï¼‰ï¼š
        <input id="answerWait" type="range" min="0" max="10" step="0.5" value="5.0" style="width: 240px; vertical-align: middle;" />
      </label>
      <span id="answerWaitVal">5.0s</span>
    </div>

    <div class="row">
      <label class="grow">ãƒ”ãƒƒãƒï¼ˆé«˜ã•ï¼‰ï¼š
        <input id="pitch" type="range" min="0.8" max="1.4" step="0.05" value="1.00" style="width: 240px; vertical-align: middle;" />
      </label>
      <span id="pitchVal">1.00</span>
    </div>

    <div class="row">
      <label>å£°ï¼ˆVoiceï¼‰ï¼š</label>
      <select id="voiceSelect" class="grow"></select>
      <button id="refreshVoices" type="button" title="éŸ³å£°ä¸€è¦§ã‚’å†å–å¾—">å†å–å¾—</button>
      <span class="muted">â€» æ—¥æœ¬èªï¼ˆja-JPï¼‰æ¨å¥¨ã€‚ç’°å¢ƒä¾å­˜ã§ã™ã€‚</span>
    </div>

    <div class="row">
      <label><input id="useKanji" type="checkbox" /> æ•°å­—ã‚’å’Œæ–‡æ•°è©ï¼ˆæ¼¢æ•°å­—ï¼‰ã§èª­ã‚€</label>
      <span class="muted">ä¾‹ï¼š123456789 â†’ åäºŒå„„ä¸‰åƒå››ç™¾äº”åå…­ä¸‡ä¸ƒåƒå…«ç™¾ä¹å</span>
    </div>

    <div class="row">
      <label><input id="speakAnswer" type="checkbox" checked /> æœ€å¾Œã«ç­”ãˆã‚’èª­ã¿ä¸Šã’ãƒ»è¡¨ç¤ºã™ã‚‹</label>
    </div>
  </fieldset>

  <div class="buttons">
    <button id="startBtn">â–¶ èª­ã¿ä¸Šã’é–‹å§‹</button>
    <button id="pauseBtn" disabled>â¸ ä¸€æ™‚åœæ­¢</button>
    <button id="resumeBtn" disabled>â–¶ å†é–‹</button>
    <button id="stopBtn" disabled>â¹ åœæ­¢</button>
    <button id="previewBtn">ğŸ”Š 1å£ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
  </div>

  <p class="muted">â€» ã‚¿ãƒ–ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã ã¨èª­ã¿ä¸Šã’ãŒæ­¢ã¾ã‚‹/é…ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚iOSã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆè§£é™¤ï¼ˆã‚µã‚¤ãƒ‰ã‚¹ã‚¤ãƒƒãƒ/é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã®è¦‹ç›´ã—ï¼‰ã‚‚ç¢ºèªã€‚</p>

  <h2>é€²è¡Œãƒ­ã‚° / å¼</h2>
  <div id="log" class="log" aria-live="polite"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const digitsEl = $('digits'), termsEl = $('terms');
  const rateEl = $('rate'), gapEl = $('gap');
  const answerWaitEl = $('answerWait'), pitchEl = $('pitch');
  const rateValEl = $('rateVal'), gapValEl = $('gapVal');
  const answerWaitValEl = $('answerWaitVal'), pitchValEl = $('pitchVal');
  const voiceSelect = $('voiceSelect'), useKanjiEl = $('useKanji');
  const speakAnswerEl = $('speakAnswer'), logEl = $('log');

  const startBtn = $('startBtn'), pauseBtn = $('pauseBtn');
  const resumeBtn = $('resumeBtn'), stopBtn = $('stopBtn');
  const previewBtn = $('previewBtn'), refreshVoicesBtn = $('refreshVoices');
  const initVoicesBtn = $('initVoicesBtn'), testUtterBtn = $('testUtterBtn');

  let voices = [];
  let isRunning = false;
  let cancelRequested = false;
  let voicesReady = false;

  const numToSpeechText = (n, useKanji=false) => useKanji ? intToKanji(n) : String(n);

  function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function clampInt(v,min,max){ if(Number.isNaN(v)) return min; return Math.min(max, Math.max(min, Math.round(v))); }

  // 12æ¡å¯¾å¿œã®ç°¡æ˜“æ¼¢æ•°å­—åŒ–ï¼ˆä¸‡ãƒ»å„„ã¾ã§ï¼‰
  function intToKanji(n){
    if(n===0) return 'é›¶';
    const unitsLarge=['','ä¸‡','å„„','å…†'];
    const digitsKanji=['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
    let s=''; let idx=0;
    while(n>0){
      const g=n%10000;
      if(g!==0){
        let t=''; const d0=g%10, d1=Math.floor(g/10)%10, d2=Math.floor(g/100)%10, d3=Math.floor(g/1000)%10;
        if(d3>0) t+=(d3===1?'':digitsKanji[d3])+'åƒ';
        if(d2>0) t+=(d2===1?'':digitsKanji[d2])+'ç™¾';
        if(d1>0) t+=(d1===1?'':digitsKanji[d1])+'å';
        if(d0>0) t+=digitsKanji[d0];
        s=t+unitsLarge[idx]+s;
      }
      idx++; n=Math.floor(n/10000);
    }
    return s;
  }

  function generateSequence(digits, terms, allowMinusRatio){
    const minVal=Math.pow(10,digits-1), maxVal=Math.pow(10,digits)-1;
    const seq=[]; let total=0;
    for(let i=0;i<terms;i++){
      const val=randInt(minVal,maxVal);
      let op='+';
      if(allowMinusRatio>0 && i>0 && Math.random()<allowMinusRatio) op='-';
      if(op==='-' && total-val<0) op='+';
      seq.push({op,val}); total += (op==='+'?val:-val);
    }
    const minusCap=Math.floor(terms*0.30);
    let minusCount=seq.filter(s=>s.op==='-').length;
    if(minusCount>minusCap){
      for(let i=seq.length-1;i>=0 && minusCount>minusCap;i--){
        if(seq[i].op==='-'){ seq[i].op='+'; minusCount--; }
      }
      total=seq.reduce((a,s)=>a+(s.op==='+'?s.val:-s.val),0);
      if(total<0){
        for(let i=seq.length-1;i>=0 && total<0;i--){
          if(seq[i].op==='-'){ seq[i].op='+'; total+=2*seq[i].val; }
        }
      }
    }
    return {seq,total};
  }

  // ---------- ãƒ­ã‚° ----------
  function log(msg, cls){ const d=document.createElement('div'); if(cls) d.className=cls; d.textContent=msg; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
  function clearLog(){ logEl.innerHTML=''; }

  // ---------- Voices åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿…é ˆï¼‰ ----------
  async function ensureVoicesLoadedWithGesture(maxTotalMs=4000){
    // ä¸€åº¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å†…éƒ¨çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå¿µã®ãŸã‚ï¼‰
    try{ speechSynthesis.cancel(); }catch{}
    // ãƒ€ãƒŸãƒ¼ç™ºè©±ï¼ˆç„¡éŸ³ã«è¿‘ã„ï¼‰ã§ãƒ­ãƒ¼ãƒ‰ã‚’ä¿ƒã™
    await new Promise((res)=>{
      const u=new SpeechSynthesisUtterance(' ');
      u.volume=0; u.rate=1.0; u.onend=()=>res(); u.onerror=()=>res();
      try{ speechSynthesis.speak(u); }catch{ res(); }
    });

    // onvoiceschanged ã‚’å¾…ã¡ã¤ã¤ãƒãƒ¼ãƒªãƒ³ã‚°
    const start=performance.now();
    const waitVoices=()=>new Promise((resolve)=> {
      let done=false;
      const check=()=>{
        const v=speechSynthesis.getVoices();
        if(v && v.length>0 && !done){ done=true; resolve(v); }
        else if((performance.now()-start) >= maxTotalMs && !done){ done=true; resolve(v); }
        else if(!done){ setTimeout(check, 100); }
      };
      const handler=()=>{
        const v=speechSynthesis.getVoices();
        if(v && v.length>0 && !done){ done=true; resolve(v); }
      };
      try{ speechSynthesis.addEventListener('voiceschanged', handler, {once:true}); }catch{ /* Safari æ—§ç‰ˆã¯ onvoiceschanged */ }
      if ('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged = handler;
      check();
    });

    const v = await waitVoices();
    return v || [];
  }

  async function populateVoices(){
    const prev=voiceSelect.value;
    const v = await ensureVoicesLoadedWithGesture(4000);
    voices = Array.isArray(v) ? v : [];
    voiceSelect.innerHTML='';

    if(!voices || voices.length===0){
      const opt=document.createElement('option');
      opt.value=''; opt.textContent='ï¼ˆéŸ³å£°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰';
      voiceSelect.appendChild(opt);
      log('éŸ³å£°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚iOSã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆè§£é™¤ï¼ç«¯æœ«ã®éŸ³é‡UPï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã«ã€Œå†å–å¾—ã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', 'warn');
      voicesReady=false;
      return;
    }

    const ja=voices.filter(v=> (v.lang||'').toLowerCase().startsWith('ja'));
    const others=voices.filter(v=> !(v.lang||'').toLowerCase().startsWith('ja'));
    [...ja, ...others].forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v.name; opt.textContent=`${v.name}  [${v.lang}${v.localService?' / local':''}]`;
      voiceSelect.appendChild(opt);
    });

    // ä»¥å‰ã®é¸æŠ or æ—¥æœ¬èªå„ªå…ˆ
    if(prev && [...voiceSelect.options].some(o=>o.value===prev)) voiceSelect.value=prev;
    else if(ja.length>0) voiceSelect.value=ja[0].name;

    voicesReady=true;
    log(`éŸ³å£°ä¸€è¦§ã‚’å–å¾—ï¼š${voices.length}ä»¶ï¼ˆé¸æŠä¸­ï¼š${voiceSelect.value || 'æ—¢å®š'}ï¼‰`, 'muted');
  }

  function pickVoiceByName(name){ return voices.find(v=>v.name===name) || null; }

  // ---------- ç™ºè©± ----------
  function speakText(text, {rate=1.0, pitch=1.0, voice=null}={}){
    return new Promise((resolve,reject)=>{
      if(!text) return resolve();
      const u=new SpeechSynthesisUtterance(text);
      if(voice) u.voice=voice; else u.lang='ja-JP';
      u.rate=rate; u.pitch=pitch;
      u.onend=()=>resolve(); u.onerror=(e)=>reject(e.error||e);
      try{ speechSynthesis.speak(u); }catch(e){ reject(e); }
    });
  }

  function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

  // ---------- UI è¡¨ç¤ºå€¤ ----------
  rateEl.addEventListener('input', ()=> rateValEl.textContent = `${parseFloat(rateEl.value).toFixed(2)}Ã—`);
  gapEl.addEventListener('input',  ()=> gapValEl.textContent  = `${parseFloat(gapEl.value).toFixed(1)}s`);
  answerWaitEl.addEventListener('input', ()=> answerWaitValEl.textContent = `${parseFloat(answerWaitEl.value).toFixed(1)}s`);
  pitchEl.addEventListener('input', ()=> pitchValEl.textContent = `${parseFloat(pitchEl.value).toFixed(2)}`);
  rateValEl.textContent=`${parseFloat(rateEl.value).toFixed(2)}Ã—`;
  gapValEl.textContent =`${parseFloat(gapEl.value).toFixed(1)}s`;
  answerWaitValEl.textContent=`${parseFloat(answerWaitEl.value).toFixed(1)}s`;
  pitchValEl.textContent=`${parseFloat(pitchEl.value).toFixed(2)}`;

  // ---------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ“ä½œ ----------
  initVoicesBtn.addEventListener('click', async ()=>{
    clearLog();
    log('éŸ³å£°åˆæœŸåŒ–ä¸­â€¦ï¼ˆæ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰', 'muted');
    await populateVoices();
  });

  testUtterBtn.addEventListener('click', async ()=>{
    try{
      const v = pickVoiceByName(voiceSelect.value);
      await speakText('ãƒ†ã‚¹ãƒˆã§ã™ã€‚', { rate:1.0, pitch:1.0, voice:v });
      log(`ãƒ†ã‚¹ãƒˆç™ºè©± OKï¼ˆ${v ? v.name+' ['+v.lang+']' : 'æ—¢å®š ja-JP'}ï¼‰`, 'ok');
    }catch(e){
      log(`ãƒ†ã‚¹ãƒˆç™ºè©±ã«å¤±æ•—ï¼š${e}`, 'err');
    }
  });

  refreshVoicesBtn.addEventListener('click', async ()=>{ await populateVoices(); });

  // ---------- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ----------
  previewBtn.addEventListener('click', async ()=>{
    if(!voicesReady){ log('å…ˆã«ã€ŒéŸ³å£°ã‚’åˆæœŸåŒ–ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'warn'); return; }
    const voice=pickVoiceByName(voiceSelect.value);
    const rate=parseFloat(rateEl.value), pitch=parseFloat(pitchEl.value);
    const useKanji=useKanjiEl.checked;
    const val=randInt(10,99);
    const text=`${numToSpeechText(val, useKanji)}å††ãªã‚Šãƒ¼`;
    try{
      await speakText(text, { rate, pitch, voice });
      log(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éŸ³å£°ï¼š${voice ? `${voice.name} [${voice.lang}]` : 'æ—¢å®šï¼ˆja-JPï¼‰'}`, 'muted');
    }catch(e){ log(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¤±æ•—ï¼š${e}`, 'err'); }
  });

  // ---------- æœ¬ç•ªé–‹å§‹ ----------
  startBtn.addEventListener('click', async ()=>{
    if(!voicesReady){ log('å…ˆã«ã€ŒéŸ³å£°ã‚’åˆæœŸåŒ–ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'warn'); return; }

    const digits=clampInt(+digitsEl.value,2,12);
    const terms =clampInt(+termsEl.value,5,20);
    const mode  =document.querySelector('input[name="mode"]:checked').value;
    const allowMinusRatio=(mode==='mix') ? 0.30 : 0.0;
    const rate  =parseFloat(rateEl.value);
    const gapSec=parseFloat(gapEl.value);
    const answerWaitSec=parseFloat(answerWaitEl.value);
    const pitch =parseFloat(pitchEl.value);
    const voice =pickVoiceByName(voiceSelect.value);
    const useKanji=useKanjiEl.checked;

    digitsEl.value=digits; termsEl.value=terms;
    clearLog();
    log(`ã€è¨­å®šã€‘æ¡æ•°:${digits}æ¡ / å£æ•°:${terms}å£ / ãƒ¢ãƒ¼ãƒ‰:${mode==='add'?'è¶³ã—ç®—ã®ã¿':'å¼•ãç®—æ··åœ¨ï¼ˆã€œ30%ï¼‰'} / é€Ÿåº¦:${rate.toFixed(2)}Ã— / é–“éš”:${gapSec.toFixed(1)}s / ãƒ”ãƒƒãƒ:${pitch.toFixed(2)} / ç­”ãˆå‰å¾…ã¡:${answerWaitSec.toFixed(1)}s / æ¼¢æ•°å­—:${useKanji?'ON':'OFF'}`, 'muted');
    log(`ä½¿ç”¨éŸ³å£°ï¼š${voice ? `${voice.name} [${voice.lang}]` : 'æ—¢å®šï¼ˆja-JPï¼‰'}`, 'muted');

    const {seq,total}=generateSequence(digits,terms,allowMinusRatio);
    log(`å¼ï¼š ${seq.map((s,i)=> (i===0?`${s.val}`:`${s.op}${s.val}`)).join(' ')}`, 'ok');

    isRunning=true; cancelRequested=false; updateButtons();

    try{
      // å†’é ­ï¼šç ç®—æ…£ç¿’
      await speakText('ã­ãŒã„ã¾ã—ã¦ã‚ãƒ¼', { rate, pitch, voice });
      await sleep(250);

      let prevOp=null;
      for(let i=0;i<seq.length;i++){
        if(cancelRequested) throw new Error('cancelled');
        const {op,val}=seq[i];

        // ç¬¦åˆãŒå¤‰ã‚ã‚‹æ™‚ã ã‘æ¥ç¶šèªï¼ˆé–“åˆã„ã¯120msï¼‰
        if(i>0 && op!==prevOp){
          const connector = (op === '+') ? 'ãã‚ãˆã¦ãƒ¼' : 'ã¨ã£ã¦ã‚';
          await speakText(connector, { rate, pitch, voice });
          await sleep(120);
        }

        const isLast=(i===seq.length-1);
        const tail=isLast ? 'å††ã§ã¯' : 'å††ãªã‚Šãƒ¼';
        const text=`${numToSpeechText(val,useKanji)}${tail}`;
        await speakText(text, { rate, pitch, voice });

        log(`ã€${i+1}å£ç›®ã€‘ ${i===0?'':op}${val}  â†’ èª­ã¿ï¼šã€Œ${useKanji?intToKanji(val):val}${isLast?'å††ã§ã¯':'å††ãªã‚Šãƒ¼'}ã€`);
        prevOp=op;

        const gapMs=Math.max(0,gapSec*1000);
        if(!isLast && gapMs>0) await sleep(gapMs);
      }

      if(speakAnswerEl.checked){
        await sleep(Math.max(0,answerWaitSec*1000));
        await speakText('ã“ãŸãˆã¯', { rate, pitch, voice });
        await sleep(150);
        const ansText=`${numToSpeechText(total,useKanji)}ã€‚ã§ã™ã€‚`;
        await speakText(ansText, { rate:Math.min(1.2, rate+0.05), pitch, voice });
        log(`ç­”ãˆï¼š ${total}ï¼ˆèª­ã¿ï¼šã€Œ${useKanji?intToKanji(total):total}ã€‚ã§ã™ã€‚ã€ï¼‰`, 'ok');
      } else {
        log('ï¼ˆç­”ãˆã®èª­ã¿ä¸Šã’ã¯ã‚ªãƒ•ï¼‰','muted');
      }

      // ã”æŒ‡å®šã«ã‚ˆã‚Šçµ‚äº†ã®å®šå‹å¥ã¯ç„¡ã—
    }catch(e){
      if(e && e.message!=='cancelled'){ log(`èª­ã¿ä¸Šã’ä¸­ã«ã‚¨ãƒ©ãƒ¼ï¼š${e}`, 'err'); }
      else{ log('åœæ­¢ã—ã¾ã—ãŸ', 'warn'); }
      try{ speechSynthesis.cancel(); }catch{}
    }finally{
      isRunning=false; cancelRequested=false; updateButtons();
    }
  });

  pauseBtn.addEventListener('click', ()=>{ if(!isRunning) return; speechSynthesis.pause(); updateButtons(); });
  resumeBtn.addEventListener('click', ()=>{ if(!isRunning) return; speechSynthesis.resume(); updateButtons(); });
  stopBtn.addEventListener('click', ()=>{ if(!isRunning) return; cancelRequested=true; speechSynthesis.cancel(); isRunning=false; updateButtons(); });

  function updateButtons(){
    startBtn.disabled=isRunning;
    pauseBtn.disabled=!isRunning;
    resumeBtn.disabled=!isRunning;
    stopBtn.disabled=!isRunning;
  }

  // ã‚¿ãƒ–å†è¡¨ç¤ºæ™‚ã« voices ãŒæ¶ˆãˆã‚‹ãƒ–ãƒ©ã‚¦ã‚¶å¯¾ç­–ï¼ˆä»»æ„å†å–å¾—ï¼‰
  document.addEventListener('visibilitychange', async ()=>{
    if(document.visibilityState==='visible' && voicesReady && speechSynthesis.getVoices().length===0){
      log('ã‚¿ãƒ–å¾©å¸°ã«ä¼´ã„éŸ³å£°ã‚’å†å–å¾—ã—ã¾ã™â€¦','muted');
      await populateVoices();
    }
  });
})();
</script>
</body>
</html>
``